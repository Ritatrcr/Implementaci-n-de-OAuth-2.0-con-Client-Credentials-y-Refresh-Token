<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Callback</title>
</head>
<body>
    <h1>Token Received</h1>
    <pre id="response"></pre>

    <script>
        window.onload = function() {
            // Obtener los parámetros de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');  // Extraer el authorization code
            const sessionState = urlParams.get('session_state');  // Extraer session_state (opcional, puede usarse para validación adicional)
            console.log(authCode);
            if (authCode) {
                const clientID = 'frontend-client';
                const clientSecret = 'BZ66COecmG2j8Vhr8QmWqUC7Y9GvglQF';  // Si es un cliente confidencial
                const redirectURI = 'http://localhost:3000/callback';  // URL de redirección configurada en Keycloak

                // Realizar la solicitud POST para intercambiar el authorization code por access token y refresh token
                fetch('http://localhost:8080/realms/OAuthRealm/protocol/openid-connect/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'client_id': clientID,
                        'client_secret': clientSecret,  // El secreto del cliente si es confidencial
                        'code': authCode,  // El código de autorización
                        'redirect_uri': redirectURI,
                        'grant_type': 'authorization_code'  // El tipo de flujo
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener el token: ' + response.statusText);
                    }
                    return response.json();  // Convertir la respuesta a JSON
                })
                .then(data => {
                    // Mostrar los tokens obtenidos en la consola y en la página
                    console.log('Access Token:', data.access_token);
                    console.log('Refresh Token:', data.refresh_token);
                    document.getElementById('response').textContent = JSON.stringify(data, null, 2);  // Mostrar en el HTML
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('response').textContent = 'Error: ' + error.message;
                });
            } else {
                // Si no se encuentra el código de autorización en la URL
                document.getElementById('response').textContent = 'No se encontró el código de autorización.';
            }
        };
    </script>
</body>
</html>
